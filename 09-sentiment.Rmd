# Эмоциональная тональность

## Анализ тональности

**Анализ тональности текста** (англ. Sentiment analysis) — задача компьютерной лингвистики, заключающаяся в определении эмоциональной окраски (тональности) текста и, в частности, в выявлении эмоциональной оценки авторов по отношению к объектам, описываемым в тексте. 

В целом, задача анализа тональности текста эквивалентна задаче классификации текста, где категориями текстов могут быть тональные оценки (позитивная, негативная или нейтральная).

## Подходы

Сделав большое обобщение, можно разделить существующие подходы на следующие категории:

- подходы, основанные на правилах;
- подходы, основанные на словарях;
- машинное обучение с учителем;
- машинное обучение без учителя.
    
В этом уроке мы будем работать только со словарями. Подробнее о других подходах можно прочитать [здесь](https://shorturl.at/cFKW1).

## Тезаурусы 

Подходы, основанные на словарях, используют так называемые тональные словари (англ. affective lexicons) для анализа текста. В простом виде тональный словарь представляет из себя список слов со значением тональности для каждого слова. 

Сравнивая текст (или отрывок текста) со словарем, мы можем вычислить тональность для всего текста (или отрывка). Словари эмоциональной тональности размечаются вручную, полуавтоматически или автоматически на основании уже существующих тезаурусов. В основном они содержат лексику из соцсетей, отзывов, Википедии, и поэтому не очень подходят для анализа литературных текстов, особенно написанных 100-200 лет назад. 

Разные тезаурусы используют разные шкалы: 

- бинарную: negative / positive  (-1 / 1)
- тринарную: бинарная + 0 (neutral)
- ранжированную: например, от -5 до 5

В некоторых случаях это дополняется различием между оценочной лексикой ("неряшливый") и негативным фактом ("кража") и т.п. 


## Лексиконы для русского языка

Установка пакета с лексиконами.

```{r eval=FALSE}
remotes::install_github("dmafanasyev/rulexicon")
```

Начало работы.

```{r message=FALSE}
library(rulexicon)
library(tidyverse)
library(tidytext)
```


### Chen & Skiena

Русский язык входит в языков, для которых Й. Чен и С. Скиена собрали оценочную лексику [@skiena2014]. Их лексикон построен на основе графа знаний, связывающего слова на разных языках (на основе Wiktionary, Google Translate, транслитерационных ссылок и WordNet). Слова оцениваются по бинарной шкале ( -1 / 1).


```{r}
set.seed(0211)
chen_skiena <- hash_sentiment_chen_skiena
sample_n(chen_skiena, 10)
```

### RuSentLex 2016

Для русского языка в свободном доступе находится РуСен-
тиЛекс [@lukashevich2016]. Он содержит около 15000 уникальных слов или фраз, среди которых оценочные слова, а также слова и выражения, не передающие оценочное отношения автора, но имеющие положительную или отрицательную ассоциацию (коннотацию). Возможные значения переменной `sentiment`: neutral, positive, negative.

```{r}
set.seed(1102)
rusenti2016 <- hash_rusentilex_2016
sample_n(rusenti2016, 10)
```


### AFINN 

Словарь AFINN содержит  7268 оценочных слов, которые оцениваются по шкале от -5 до +5.

```{r}
set.seed(0211)
afinn <- hash_sentiment_afinn_ru
sample_n(afinn, 10)
```

### NRC

Переведенная версия списка положительных и отрицательных слов Mohammad & Turney (2010)^[https://aclanthology.org/W10-0204/]. Таблица содержит 5179 слов с не нейтральными оценками. Бинарная шкала: -1 / 1.

```{r}
set.seed(0211)
nrc <- hash_sentiment_nrc_emolex_ru
sample_n(nrc, 10)
```



## Анализ тональности с Tidy Data

[@textmining2017], говоря об анализе эмоционально тональности в духе tidy data, предлагают следующую иллюстрацию:

![](https://www.tidytextmining.com/images/tmwr_0201.png)
Авторы предостерегают, впрочем, что современные лексиконы могут быть не слишком информативны применительно к классической литературе (в книге анализируются романы Джейн Остин). Мы попробуем, тем не менее, подвергнуть "сентиментальному анализу" сентиментальную прозу Карамзина. 

Прежде всего для этого ее необходимо токенизировать, лемматизировать и привести в опрятный формат, как мы делали в предыдущем уроке.

```{r warning=FALSE, echo=FALSE}
library(udpipe)
liza <- readLines(con = "files/karamzin_liza.txt")

russian_syntagrus <- udpipe_load_model(file = "russian-syntagrus-ud-2.5-191206.udpipe")

liza_ann <- udpipe_annotate(russian_syntagrus, liza)
```


```{r}
liza_tbl <- as_tibble(liza_ann) %>% 
  filter(upos != "PUNCT") %>% 
  select(lemma) %>% 
  rename(token = lemma) %>% 
  mutate(chunk = round(((row_number() + 50) / 100), 0))

liza_tbl
```

Стоп-слова, то есть слова, не несущие никакой смысловой нагрузки, нам не нужны, но удалять их отдельно нет смысла: мы соединим, при помощи функции `inner_join()` (см. предыдущие уроки), наш текст с одним из лексиконов, и это само по себе отфильтрует ту лексику, которая может быть потенциально интересна. 

Напомню, что `inner_join()` работает так:

![](https://d33wubrfki0l68.cloudfront.net/3abea0b730526c3f053a3838953c35a0ccbe8980/7f29b/diagrams/join-inner.png){ width=70% }

```{r warning=FALSE}
liza_sent <- liza_tbl %>% 
  inner_join(rusenti2016) %>% 
  select(-lemma, -ambiguity, -source) %>% 
  filter(sentiment != "neutral")

liza_sent
```

## Негативные и позитивные слова

Посмотрим на общую статистику.

```{r}
liza_sent %>% 
  count(token, sentiment) %>% 
  arrange(-n)
```

Вы уже догадались, что это можно изобразить в виде любезных столбиков:

```{r}
liza_sent %>% 
  count(token, sentiment) %>% 
  arrange(-n) %>% 
  top_n(15) %>% 
  ggplot(aes(reorder(token, n), n, fill = sentiment)) +
  geom_bar(stat = "identity") +
  facet_wrap(~sentiment, scales = "free")  +
  coord_flip() +
  xlab(NULL)
```

Ок, с "зеленым" явно вышла неувязка. Удалим его вручную. "Старый" тоже можно удалить: в доброй старушке у Карамзина явно ничего плохого нет.  "Тучный" в этом произведении окрашено скорее положительно, можно внести изменения.

```{r}
liza_sent <- liza_sent %>%
  filter(!token %in% c("зеленый", "старый")) %>% 
  mutate_at(vars(sentiment), ~ 
       case_when(token == "тучный" ~  "positive", TRUE ~ .))
```

Для нескольких слов переменная sentiment имеет значение "positive/negative", здесь мы тоже можем внести ясность вручную:

```{r}
liza_sent <- liza_sent %>% 
  mutate_at(vars(sentiment), ~ 
       case_when(token %in% c("простой", "тихий", "чувствительный", "честь") ~  "positive", 
                 token == "праздность" ~ "negative",
                 TRUE ~ .)) %>% 
  filter(sentiment != "positive/negative")
```

## Облако эмоций

Для разнообразия, чтобы не переделывать столбики, представим эмоциональную лексику в виде облака слов. Но не простого облака, а сравнительного.

```{r warning=FALSE}
library(reshape2)
library(wordcloud)

liza_sent %>% 
  count(token, sentiment, sort = T) %>% 
  acast(token ~ sentiment, value.var = "n", fill = 0) %>% 
  comparison.cloud(colors = c("grey20", "grey80"),
                   max.words = 100)

```

В виде обычного облака можно показать  отдельно положительно окрашенную лексику:

```{r}
liza_sent %>% 
  filter(sentiment == "positive") %>% 
  count(token, sort = T) %>% 
  with(wordcloud(token, n, max.words = 100))
```
Такое облако стоит заламинировать и повесить на стену.

## Тональность текста в целом

Чтобы делать какие-то выводы о повести в целом, нам нужно перевести столбец sentiment в числовой формат:

```{r}
liza_sent_num <- liza_sent %>% 
  mutate(sentiment = case_when(sentiment == "positive" ~ 1,
                               sentiment == "negative" ~ -1))

liza_sent_num %>% summarise(sum = sum(sentiment))

# или, что то же самое
sum(liza_sent_num$sentiment)
```

Сумма значительно больше нуля, а значит положительные чувства в повести, хотя и со вздохами, преобладают!

## Эмоции и развитие сюжета

Мы можем посчитать такие же суммы для каждого из отрывков.

```{r}
liza_chunk_sent <- liza_sent_num %>% 
  group_by(chunk) %>% 
  summarise(sum = sum(sentiment))
```

Теперь смену доминирующего настроения можно отразить на оси повествовательного времени. Добавим еще одну категориальную переменную, она понадобится для визуализации.

```{r}
liza_chunk_sent <- liza_chunk_sent %>% 
  mutate(tone = case_when( sum >= 0 ~ "pos",
                           sum < 0 ~ "neg"))
```
         
```{r}
ggplot(liza_chunk_sent, aes(chunk, sum, fill = tone)) +
  geom_col(show.legend = F)
```

Негативная тональность в начале повести, в районе 500-го слова, не имеет ничего общего с развитием сюжета: здесь такие слова, как "неприятель", "опустошать". Рассказчик, глядя на опустевший монастырь, вспоминает о "печальной истории" нашего отечества.

11-й отрывок: тревога матери о судьбе дочери. "У меня всегда сердце бывает не на своем месте, когда ты ходишь в город; я всегда ставлю свечу перед образ и молю господа бога, чтобы он сохранил тебя от всякой беды и напасти". Здесь отразилось романтическое представление Карамзина о городе как обители греха и всяких бедствий.

34-й отрывок -- это падение Лизы: "Грозно шумела буря, дождь лился из черных облаков — казалось, что натура сетовала о потерянной Лизиной невинности". С точки зрения эмоциональной окрашенности этот место даже более насыщено, чем эпизод самоубийства Лизы. 

Негативная тональность в конце повести связана не столько с гибелью дочери, сколько со скорбной смертью ее матери, "доброй старушки": "Лизина мать услышала о страшной смерти дочери своей, и кровь ее от ужаса охладела — глаза навек закрылись". Мы уже видели в предыдущем уроке, что мать в повести упоминается чаще, чем Лиза (21 раз против 16). Но и ее физическая смерть описана не так мрачно и тревожно, как падение Лизы. 

Любопытно, что самые мрачные фрагменты повести (по крайней мере, с количественной точки зрения) посвящены не судьбе бедной девушки, а судьбе отечества: Карамзин историк переигрывает Карамзина-новелиста. Вот это место: 

> Иногда на вратах храма рассматриваю изображение чудес, в сем монастыре случившихся, там рыбы падают с неба для насыщения жителей монастыря, осажденного многочисленными врагами; тут образ богоматери обращает неприятелей в бегство. Все сие обновляет в моей памяти историю нашего отечества — печальную историю тех времен, когда свирепые татары и литовцы огнем и мечом опустошали окрестности российской столицы и когда несчастная Москва, как беззащитная вдовица, от одного бога ожидала помощи в лютых своих бедствиях.

Жанр сентиментальной повести вынуждает Карамзина говорить о судьбе обманутой девушки, но гораздо большее сочувствие вызывают у него две беззащитные вдовицы: Москва и Лизина мать.

