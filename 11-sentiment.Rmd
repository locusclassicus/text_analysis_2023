# Эмоциональная тональность

## Анализ тональности

**Анализ тональности текста** (англ. Sentiment analysis) — задача компьютерной лингвистики, заключающаяся в определении эмоциональной окраски (тональности) текста и, в частности, в выявлении эмоциональной оценки авторов по отношению к объектам, описываемым в тексте. 

В целом, задача анализа тональности текста эквивалентна задаче классификации текста, где категориями текстов могут быть тональные оценки (позитивная, негативная или нейтральная).

## Подходы

Сделав большое обобщение, можно разделить существующие подходы на следующие категории:

- подходы, основанные на правилах;
- подходы, основанные на словарях;
- машинное обучение с учителем;
- машинное обучение без учителя.
    
В этом уроке мы будем работать только со словарями. Подробнее о других подходах можно прочитать [здесь](https://shorturl.at/cFKW1).

## Тезаурусы 

Подходы, основанные на словарях, используют так называемые тональные словари (англ. affective lexicons) для анализа текста. В простом виде тональный словарь представляет из себя список слов со значением тональности для каждого слова. 

Сравнивая текст (или отрывок текста) со словарем, мы можем вычислить тональность для всего текста (или отрывка). Словари эмоциональной тональности размечаются вручную, полуавтоматически или автоматически на основании уже существующих тезаурусов. В основном они содержат лексику из соцсетей, отзывов, Википедии, и поэтому не очень подходят для анализа литературных текстов, особенно написанных 100-200 лет назад. 

Разные тезаурусы используют разные шкалы: 

- бинарную: negative / positive  (-1 / 1)
- тринарную: бинарная + 0 (neutral)
- ранжированную: например, от -5 до 5

В некоторых случаях дополнительно вводятся различия между оценочной лексикой ("неряшливый") и негативным фактом ("кража") и т.п. 


## Лексиконы для русского языка

Установка пакета с лексиконами.

```{r eval=FALSE}
remotes::install_github("dmafanasyev/rulexicon")
```

Начало работы.

```{r message=FALSE}
library(rulexicon)
library(tidyverse)
library(tidytext)
```


### Chen & Skiena

Русский язык входит в языков, для которых Й. Чен и С. Скиена собрали оценочную лексику [@skiena2014]. Их лексикон построен на основе графа знаний, связывающего слова на разных языках (на основе Wiktionary, Google Translate, транслитерационных ссылок и WordNet). Слова оцениваются по бинарной шкале ( -1 / 1).


```{r}
set.seed(0211)
chen_skiena <- hash_sentiment_chen_skiena
sample_n(chen_skiena, 10)
```

### RuSentLex 2016

Для русского языка в свободном доступе находится РуСентиЛекс [@lukashevich2016]. Он содержит около 15000 уникальных слов или фраз, среди которых оценочные слова, а также слова и выражения, не передающие оценочное отношения автора, но имеющие положительную или отрицательную ассоциацию (коннотацию). Возможные значения переменной `sentiment`: neutral, positive, negative, positive/negative. 

```{r}
set.seed(1102)
rusenti2016 <- hash_rusentilex_2016
sample_n(rusenti2016, 10)
```

При работе с этим лексиконом следует учитывать, что для отдельных слов он содержит несколько вхождений, как положительных, так и отрицательных, например:

```{r}
rusenti2016 %>% 
  filter(token == "нежный")
```

### AFINN 

Словарь AFINN содержит  7268 оценочных слов. Их тональность оценивается по шкале от -5 (крайне негативная) до 5 (в высшей степени положительная). Например, слово "адский" имеет оценку -5, а слово "ангельский" -- +5.

```{r}
set.seed(0211)
afinn <- hash_sentiment_afinn_ru
sample_n(afinn, 10)
```

### NRC

Переведенная версия списка положительных и отрицательных слов Mohammad & Turney (2010)^[https://aclanthology.org/W10-0204/]. Таблица содержит 5179 слов с не нейтральными оценками. Бинарная шкала: -1 / 1.

```{r}
set.seed(1102)
nrc <- hash_sentiment_nrc_emolex_ru
sample_n(nrc, 10)
```



## Анализ тональности с Tidy Data

[@textmining2017], говоря об анализе эмоциональной тональности в духе tidy data, предлагают следующую иллюстрацию:

![](https://www.tidytextmining.com/images/tmwr_0201.png)

Авторы предостерегают, впрочем, что современные лексиконы могут быть не слишком информативны применительно к классической литературе (в книге анализируются романы Джейн Остин). Мы попробуем, тем не менее, подвергнуть "сентиментальному анализу" сентиментальную прозу Карамзина. 

## Подготовка текста

Прежде всего текст необходимо токенизировать, лемматизировать и привести в опрятный формат, как мы делали в предыдущем уроке.

```{r warning=FALSE}
library(udpipe)
liza <- readLines(con = "files/karamzin_liza.txt")

russian_syntagrus <- udpipe_load_model(file = "russian-syntagrus-ud-2.5-191206.udpipe")

liza_ann <- udpipe_annotate(russian_syntagrus, liza)

liza_df <- as_tibble(liza_ann) %>% 
  select(-paragraph_id, -sentence, -xpos)
```

Разделим весь текст "Лизы" на отрывки по 100 слов: это позволит проверить, как меняется эмоциональная тональность произведения по мере развития сюжета. 

```{r}
liza_tbl <- as_tibble(liza_ann) %>% 
  filter(upos != "PUNCT") %>% 
  select(lemma) %>% 
  rename(token = lemma) %>% 
  mutate(chunk = round(((row_number() + 50) / 100), 0))

liza_tbl
```

В тексте чуть более 5000 слов, у нас получился 51 отрывок.  

## Модификация лексикона

Для анализа эмоциональной тональности возьмем лексикон AFINN, доступный в пакете `rulexicon`.  Слово "старый" имеет в этом лексиконе отрицательную оценку, что не соответствует словоупотреблению Карамзина, и мы его удалили; слову "чувствительный" поменяли знак с минуса на плюс, поскольку для автора "Бедной Лизы" это скорее положительное качество.

Код ниже показывает, как вносятся подобные изменения:

```{r}
lex <- hash_sentiment_afinn_ru

lex <- lex %>% filter(token != "старый")

lex <- lex %>% mutate_at(vars(score), ~
       case_when(token == "чувствительный" ~  1.7,
                 TRUE ~ .))
```

## Соединение лексикона и текста

Стоп-слова, то есть слова, не несущие никакой смысловой нагрузки, нам не нужны, но удалять их отдельно нет смысла: мы соединим, при помощи функции `inner_join()` (см. предыдущие уроки), наш текст с одним из лексиконов, и это само по себе отфильтрует ту лексику, которая может быть потенциально интересна. Напомню, что `inner_join()` работает так:

![](https://d33wubrfki0l68.cloudfront.net/3abea0b730526c3f053a3838953c35a0ccbe8980/7f29b/diagrams/join-inner.png){ width=70% }


```{r message=FALSE}
liza_sent <- liza_tbl %>% 
  inner_join(lex)

liza_sent
```

Сложив положительно и отрицательно окрашенную лексику для каждого отрывка, получаем значение, позволяющее судить о доминирующей тональности:

```{r}
liza_chunk_sent <- liza_sent %>% 
  group_by(chunk) %>% 
  summarise(sum = sum(score)) %>% 
  arrange(sum)

head(liza_chunk_sent, 10)
```

Довольно неожиданно, что самый негативный отрывок находится не в конце повести, ближе к трагической ее развязке, а почти в начале (отрывок 5, ср. отрывки 3 и 4 рядом). Представим эмоционально окрашенную лексику отрывков 3-5 в виде сравнительного облака слов:

```{r warning=FALSE, message=FALSE}
library(reshape2)
library(wordcloud)

# добавляем новый столбец для удобства визуализации
liza_sent_class <- liza_sent %>% 
  mutate(tone = case_when( score >= 0 ~ "pos",
                           score < 0 ~ "neg"))
set.seed(0211)
liza_sent_class %>% 
  filter(chunk %in% c(3, 4, 5)) %>% 
  count(token, tone, sort = T) %>% 
  acast(token ~ tone, value.var = "n", fill = 0) %>% 
  comparison.cloud(colors = c("grey20", "grey80"),
                   max.words = 99)
```

Здесь видно, что негативная тональность в этой части не связана с судьбой героев: об этом говорят такие слова, как "лютый", "враг", "свирепый". Рассказчик, глядя на заброшенный Симонов монастырь, вспоминает о "печальной истории" Москвы. Таким образом, **с количественной точки зрения, самые мрачный фрагмент повести посвящен не судьбе бедной девушки, а "глухому стону времен"**: Карамзин-историк уже переигрывает Карамзина-новелиста.

Приведем небольшой отрывок из этой части повести:

> Иногда на вратах храма рассматриваю изображение чудес, в сем монастыре случившихся, там рыбы падают с неба для насыщения жителей монастыря, осажденного многочисленными врагами; тут образ богоматери обращает неприятелей в бегство. Все сие обновляет в моей памяти историю нашего отечества — печальную историю тех времен, когда свирепые татары и литовцы огнем и мечом опустошали окрестности российской столицы и когда несчастная Москва, как беззащитная вдовица, от одного бога ожидала помощи в лютых своих бедствиях.

## Тональность на оси времени

Таблица, которую мы подготовили, позволяет наглядно показать, как меняется тональность во времени -- разумеется, речь идет о повествовательном времени, которое измеряется не в минутах, а в словах. Каждый отрывок, напомню, -- это 100 слов.

```{r message=FALSE, warning=FALSE}

liza_chunk_sent <- liza_chunk_sent %>% 
  mutate(tone = case_when( sum >= 0 ~ "pos",
                           sum < 0 ~ "neg"))

library(ggplot2)
ggplot(liza_chunk_sent, aes(chunk, sum, fill = tone)) +
  geom_col(show.legend = F)
```

График получился весьма осмысленным. Мы уже сказали выше про отрывки 3-4. Дальше немного скорби в отрывке 8 посвящено покойному отцу Лизы. В 11-м отрывке отразилась тревога матери за судьбу дочери: "коварно", "обидеть", "дурной" вносят вклад в настроение этого фрагмента. Это достаточно характерно для сентиментальной прозы с ее противопоставлением пороков городской жизни и пасторальных добродетелей. 

> У меня всегда сердце бывает не на своем месте, когда ты ходишь в город; я всегда ставлю свечу перед образ и молю господа бога, чтобы он сохранил тебя от всякой беды и напасти. 

_В отрывке 15 несколько негативных слов имеют перед собой отрицания ("не подозревая", "никакого худого намерения" и т.п.), поэтому к числу отрицательно окрашенных он отнесен ошибочно_.  К сожалению, это недостаток подхода, основанного на словарях, не принимающего в учет синтаксические связи в предложении.  

Еще два минимума: отрывки 31 и 34. В первом из них Лиза встревожена вестью о возможном замужестве с сыном крестьянина. Отрывок 34 – это падение Лизы: 

> Грозно шумела буря, дождь лился из черных облаков — казалось, что натура сетовала о потерянной Лизиной невинности.

На графике видно, что **это место гораздо более эмоционально, чем эпизод самоубийства Лизы**: именно после знаменитых карамзинских многоточий и тире события устремляются к трагическому финалу. О самой смерти девушки Карамзин говорит, конечно, с грустью, но без надрыва: "Тут она бросилась в воду". 

38, 39, 42 -- Эраст отправляется на войну. Все, как это принято у Карамзина, плачут, что зафиксировал и наш график.

Наконец, в отрывках 49-51 доминирует тема смерти:

```{r}
library(RColorBrewer)
pal <- RColorBrewer::brewer.pal(5, "Dark2")

liza_sent_class %>% 
  filter(chunk %in% c(49:51)) %>% 
  filter(tone == "neg") %>% 
  count(token, sort = T) %>% 
  with(wordcloud(token, n, max.words = 100, colors = pal))
```

Следует отметить, что часть этих слов относится не к самой девушке, а к ее матери.

## Для других языков

Для языков, которые используют латиницу, в R есть отличный пакет под названием `syuzhet`. Его разработал известный цифровой литературовед Мэтью Джокерс^[https://cran.r-project.org/web/packages/syuzhet/vignettes/syuzhet-vignette.html]. Название пакета, как говорит его разработчик, подсмотрено у русских формалистов Виктора Шкловского и Владимира Проппа. Возможности и ограничения этого пакета обсуждались в специальной литературе^[http://www.digitalhumanities.org/dhq/vol/16/2/000612/000612.html]. 

Для анализа возьмем стихотворение Роберта Фроста "Медведи" ([перевод](https://t.me/antibarbari/1098)).

```{r}
library(syuzhet)

my_example_text <- "The bear puts both arms around the tree above her
And draws it down as if it were a lover
And its choke cherries lips to kiss good-bye,
Then lets it snap back upright in the sky.
Her next step rocks a boulder on the wall
(She's making her cross-country in the fall).
Her great weight creaks the barbed-wire in its staples
As she flings over and off down through the maples,
Leaving on one wire moth a lock of hair.
Such is the uncaged progress of the bear.
The world has room to make a bear feel free;
The universe seems cramped to you and me.
Man acts more like the poor bear in a cage
That all day fights a nervous inward rage - 
His mood rejecting all his mind suggests.
He paces back and forth and never rests
The toe-nail click and shuffle of his feet,
The telescope at one end of his beat -
And at the other end the microscope,
Two instruments of nearly equal hope,
And in conjunction giving quite a spread.
Or if he rests from scientific tread,
'Tis only to sit back and sway his head
Through ninety odd degrees of arc, it seems,
Between two metaphysical extremes.
He sits back on his fundamental butt
With lifted snout and eyes (if any) shut,
(he almost looks religious but he's not),
And back and forth he sways from cheek to cheek,
At one extreme agreeing with one Greek -
At the other agreeing with another Greek
Which may be thought, but only so to speak.
A baggy figure, equally pathetic
When sedentary and when peripatetic."
```

Пакет позволяет разделить текст на предложения:

```{r}
sent_vec <- get_sentences(my_example_text)
sent_vec[1:2]
```
Воспользуемся регулярными выражениями, чтобы удалить переносы строк:

```{r}
library(stringr)
sent_vec <- str_replace_all(sent_vec, "\\n", " ")
sent_vec[1:2]
```
Если вы хотите прочитать в R большой файл, для этого есть функция `get_text_as_string`, который необходимо указать путь к файлу на компьютере или url. 

Функция `get_sentiment` принимает в качестве аргументов вектор и метод (о методах можно подробнее узнать, вызвав помощь). 

```{r}
bing_vector <- get_sentiment(sent_vec, method="bing")

bing_vector
```
Как видно, не очень радостное стихотворение. Взглянем на самое мрачное предложение:

```{r}
sent_vec[which.min(bing_vector)]
```
Результат применения различных методов может несколько отличаться. 

```{r}
afinn_vector <- get_sentiment(sent_vec, method="afinn")

afinn_vector

sent_vec[which.min(afinn_vector)]
```

Но в нашем случае методы согласны: сравнение человека с беспокойным медведем в клетке -- эмоциональный минимум стихотворения.

Эмоциональная валентность произведения в целом вычисляется либо как сумма, либо как среднее всех значений:

```{r}
sum(afinn_vector)
mean(afinn_vector)
```

Не так уж плохо: за счет первой части про медведицу, с удовольствием поедающую черемуху, общая тональность скорее положительная (хотя ваш читательский опыт может говорить об обратном). 

Результат можно передать функции `plot()`:

```{r}
plot(afinn_vector, 
     type="l", 
     main="Example Plot Trajectory",
     xlab = "Narrative Time",
     ylab= "Emotional Valence")
```

О других способах визуализировать результат можно узнать из [виньетки к пакету](https://cran.r-project.org/web/packages/syuzhet/vignettes/syuzhet-vignette.html).

## Виды эмоций

Лексикон NRC дает возможность позволяет не просто оценить эмоциональную валентность, но и выявить конкретные эмоции: 

```{r warning=FALSE}
nrc_data <- get_nrc_sentiment(sent_vec)

nrc_data
```

Выбрать конкретные эмоции можно так (но результат в нашем случае не очень осмысленный):

```{r eval=FALSE}
joy_items <- which(nrc_data$joy > 0)
sent_vec[joy_items]
```

На графике это можно отразить при помощи базовой `barplot`:

```{r}
barplot(
  sort(colSums(prop.table(nrc_data[, 1:8]))), 
  horiz = TRUE, 
  cex.names = 0.7, 
  las = 1, 
  main = "Emotions in Sample text", xlab="Percentage"
  )
```

Сложно осуждать машину за не вполне верно считанную тональность: Фрост -- сложный автор. Для отзывов на Tripadvisor это может сработать лучше.




