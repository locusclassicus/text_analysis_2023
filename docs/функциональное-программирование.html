<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Тема 5 Функциональное программирование | Компьютерный анализ текста в R</title>
  <meta name="description" content="Все прекрасное трудно." />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="Тема 5 Функциональное программирование | Компьютерный анализ текста в R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Все прекрасное трудно." />
  <meta name="github-repo" content="https://github.com/locusclassicus/text_analysis_r_bookdown_2023/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Тема 5 Функциональное программирование | Компьютерный анализ текста в R" />
  
  <meta name="twitter:description" content="Все прекрасное трудно." />
  

<meta name="author" content="Ольга Алиева" />


<meta name="date" content="2023-07-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="опрятные-данные.html"/>
<link rel="next" href="blocks.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Компьютерный анализ текста в R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> О курсе</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#благодарности"><i class="fa fa-check"></i><b>1.1</b> Благодарности</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html"><i class="fa fa-check"></i><b>2</b> Начало работы с R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#что-такое-r"><i class="fa fa-check"></i><b>2.1</b> Что такое R?</a></li>
<li class="chapter" data-level="2.2" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#пакеты-и-виньетки"><i class="fa fa-check"></i><b>2.2</b> Пакеты и виньетки</a></li>
<li class="chapter" data-level="2.3" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#если-не-хватает-пакетов"><i class="fa fa-check"></i><b>2.3</b> Если не хватает пакетов</a></li>
<li class="chapter" data-level="2.4" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#о-воспроизводимости"><i class="fa fa-check"></i><b>2.4</b> О воспроизводимости</a></li>
<li class="chapter" data-level="2.5" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#что-мы-не-будем-делать"><i class="fa fa-check"></i><b>2.5</b> Что мы (не) будем делать?</a></li>
<li class="chapter" data-level="2.6" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#rstudio"><i class="fa fa-check"></i><b>2.6</b> RStudio</a></li>
<li class="chapter" data-level="2.7" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#установка"><i class="fa fa-check"></i><b>2.7</b> Установка</a></li>
<li class="chapter" data-level="2.8" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#начало-работы"><i class="fa fa-check"></i><b>2.8</b> Начало работы</a></li>
<li class="chapter" data-level="2.9" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#r-как-калькулятор"><i class="fa fa-check"></i><b>2.9</b> R как калькулятор</a></li>
<li class="chapter" data-level="2.10" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#операторы-присваивания"><i class="fa fa-check"></i><b>2.10</b> Операторы присваивания</a></li>
<li class="chapter" data-level="2.11" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#векторы"><i class="fa fa-check"></i><b>2.11</b> Векторы</a></li>
<li class="chapter" data-level="2.12" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#списки"><i class="fa fa-check"></i><b>2.12</b> Списки</a></li>
<li class="chapter" data-level="2.13" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#матрицы"><i class="fa fa-check"></i><b>2.13</b> Матрицы</a></li>
<li class="chapter" data-level="2.14" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#таблицы"><i class="fa fa-check"></i><b>2.14</b> Таблицы</a></li>
<li class="chapter" data-level="2.15" data-path="начало-работы-с-r.html"><a href="начало-работы-с-r.html#шорткаты"><i class="fa fa-check"></i><b>2.15</b> Шорткаты</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="визуализации.html"><a href="визуализации.html"><i class="fa fa-check"></i><b>3</b> Визуализации</a>
<ul>
<li class="chapter" data-level="3.1" data-path="визуализации.html"><a href="визуализации.html#базовый-r"><i class="fa fa-check"></i><b>3.1</b> Базовый R</a></li>
<li class="chapter" data-level="3.2" data-path="визуализации.html"><a href="визуализации.html#lattice"><i class="fa fa-check"></i><b>3.2</b> Lattice</a></li>
<li class="chapter" data-level="3.3" data-path="визуализации.html"><a href="визуализации.html#ggplot2"><i class="fa fa-check"></i><b>3.3</b> Ggplot2</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="визуализации.html"><a href="визуализации.html#быстрое-решение-qplot"><i class="fa fa-check"></i><b>3.3.1</b> Быстрое решение: qplot()</a></li>
<li class="chapter" data-level="3.3.2" data-path="визуализации.html"><a href="визуализации.html#слой-за-слоем-ggplot"><i class="fa fa-check"></i><b>3.3.2</b> Слой за слоем: ggplot()</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="визуализации.html"><a href="визуализации.html#экспорт-графиков-из-среды-r"><i class="fa fa-check"></i><b>3.4</b> Экспорт графиков из среды R</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="опрятные-данные.html"><a href="опрятные-данные.html"><i class="fa fa-check"></i><b>4</b> Опрятные данные</a>
<ul>
<li class="chapter" data-level="4.1" data-path="опрятные-данные.html"><a href="опрятные-данные.html#синтаксис-tidyverse"><i class="fa fa-check"></i><b>4.1</b> Синтаксис tidyverse</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="опрятные-данные.html"><a href="опрятные-данные.html#tibble"><i class="fa fa-check"></i><b>4.1.1</b> Tibble</a></li>
<li class="chapter" data-level="4.1.2" data-path="опрятные-данные.html"><a href="опрятные-данные.html#dplyr"><i class="fa fa-check"></i><b>4.1.2</b> Dplyr</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="опрятные-данные.html"><a href="опрятные-данные.html#опрятные-данные-1"><i class="fa fa-check"></i><b>4.2</b> Опрятные данные</a></li>
<li class="chapter" data-level="4.3" data-path="опрятные-данные.html"><a href="опрятные-данные.html#пример-буккроссинг"><i class="fa fa-check"></i><b>4.3</b> Пример: буккроссинг</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="опрятные-данные.html"><a href="опрятные-данные.html#смотрим-на-данные"><i class="fa fa-check"></i><b>4.3.1</b> Смотрим на данные</a></li>
<li class="chapter" data-level="4.3.2" data-path="опрятные-данные.html"><a href="опрятные-данные.html#трансформируем-данные"><i class="fa fa-check"></i><b>4.3.2</b> Трансформируем данные</a></li>
<li class="chapter" data-level="4.3.3" data-path="опрятные-данные.html"><a href="опрятные-данные.html#объединяем-данные"><i class="fa fa-check"></i><b>4.3.3</b> Объединяем данные</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html"><i class="fa fa-check"></i><b>5</b> Функциональное программирование</a>
<ul>
<li class="chapter" data-level="5.1" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#зачем-писать-функции"><i class="fa fa-check"></i><b>5.1</b> Зачем писать функции?</a></li>
<li class="chapter" data-level="5.2" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#область-видимости-переменных"><i class="fa fa-check"></i><b>5.2</b> Область видимости переменных</a></li>
<li class="chapter" data-level="5.3" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#аргументы-функции"><i class="fa fa-check"></i><b>5.3</b> Аргументы функции</a></li>
<li class="chapter" data-level="5.4" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#векторизируй-это"><i class="fa fa-check"></i><b>5.4</b> Векторизируй это</a></li>
<li class="chapter" data-level="5.5" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#векторизованные-конструкции"><i class="fa fa-check"></i><b>5.5</b> Векторизованные конструкции</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#циклы"><i class="fa fa-check"></i><b>5.5.1</b> Циклы</a></li>
<li class="chapter" data-level="5.5.2" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#условия"><i class="fa fa-check"></i><b>5.5.2</b> Условия</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#вместо-циклов-базовый-r-и-tidyverse"><i class="fa fa-check"></i><b>5.6</b> Вместо циклов: базовый R и tidyverse</a></li>
<li class="chapter" data-level="5.7" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#purrr"><i class="fa fa-check"></i><b>5.7</b> Purrr</a></li>
<li class="chapter" data-level="5.8" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#пример-итерации"><i class="fa fa-check"></i><b>5.8</b> Пример итерации</a></li>
<li class="chapter" data-level="5.9" data-path="функциональное-программирование.html"><a href="функциональное-программирование.html#furrr"><i class="fa fa-check"></i><b>5.9</b> Furrr</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="blocks.html"><a href="blocks.html"><i class="fa fa-check"></i><b>6</b> Blocks</a>
<ul>
<li class="chapter" data-level="6.1" data-path="blocks.html"><a href="blocks.html#equations"><i class="fa fa-check"></i><b>6.1</b> Equations</a></li>
<li class="chapter" data-level="6.2" data-path="blocks.html"><a href="blocks.html#theorems-and-proofs"><i class="fa fa-check"></i><b>6.2</b> Theorems and proofs</a></li>
<li class="chapter" data-level="6.3" data-path="blocks.html"><a href="blocks.html#callout-blocks"><i class="fa fa-check"></i><b>6.3</b> Callout blocks</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="sharing-your-book.html"><a href="sharing-your-book.html"><i class="fa fa-check"></i><b>7</b> Sharing your book</a>
<ul>
<li class="chapter" data-level="7.1" data-path="sharing-your-book.html"><a href="sharing-your-book.html#publishing"><i class="fa fa-check"></i><b>7.1</b> Publishing</a></li>
<li class="chapter" data-level="7.2" data-path="sharing-your-book.html"><a href="sharing-your-book.html#pages"><i class="fa fa-check"></i><b>7.2</b> 404 pages</a></li>
<li class="chapter" data-level="7.3" data-path="sharing-your-book.html"><a href="sharing-your-book.html#metadata-for-sharing"><i class="fa fa-check"></i><b>7.3</b> Metadata for sharing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Компьютерный анализ текста в R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="функциональное-программирование" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Тема 5</span> Функциональное программирование<a href="функциональное-программирование.html#функциональное-программирование" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="зачем-писать-функции" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Зачем писать функции?<a href="функциональное-программирование.html#зачем-писать-функции" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Программировать на R – прежде всего значит писать функции. Несмотря на десятки тысяч функций, обитающих в тысячах пакетов, рано или поздно вам понадобится своя функция, которая будет подходить для решения именно ваших задач.</p>
<p>Функция и код – не одно и то же. Чтобы стать функцией, кусок кода должен, как минимум, получить имя. Зачем давать имя коду, который и так работает?</p>
<p>Вот три причины, которые <a href="https://r4ds.had.co.nz/functions.html">приводит</a> Хадли Уикхем:</p>
<ul>
<li>у функции есть выразительное имя, которое облегчает понимание кода;</li>
<li>при изменении требований необходимо обновлять код только в одном месте, а не во многих;</li>
<li>меньше вероятность случайных ошибок при копировании (например, обновление имени переменной в одном месте, но не в другом)</li>
</ul>
<blockquote>
<p>Writing good functions is a lifetime journey.</p>
<p>— Hadley Wickham</p>
</blockquote>
<p>Чтобы определить функцию, необходимо дать ей имя. Машине все равно, как вы назовете функцию, но тем, кто будет читать код, не все равно. Имена должны быть информативы (поэтому функция <code>f()</code> – плохая идея). Также не стоит переписывать уже существующие в R имена!</p>
<p>Далее следует определить <strong>формальные аргументы</strong> и, при желании, <strong>значения по умолчанию</strong>. Тело функции пишется в фигурных скобках. В конце кода функции располагается команда <code>return()</code>; если ее нет, то функция возвращает последнее вычисленное значение (см. <a href="https://r4ds.had.co.nz/functions.html">здесь</a> о том, когда что предпочесть).</p>
<p>Написание функций – навык, который можно бесконечно совершенствовать. Начать проще всего с обычного кода. Убедившись, что он работает как надо, вы можете упаковать его в функцию.</p>
<p>Например, нам нужна функция, которая ищет совпадения в двух векторах и возвращает совпавшие элементы. Сначала решим задачу для двух векторов.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="функциональное-программирование.html#cb189-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;гнев&quot;</span>, <span class="st">&quot;богиня&quot;</span>, <span class="st">&quot;воспой&quot;</span>)</span>
<span id="cb189-2"><a href="функциональное-программирование.html#cb189-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;в&quot;</span>, <span class="st">&quot;мысли&quot;</span>, <span class="st">&quot;ему&quot;</span>, <span class="st">&quot;то&quot;</span>, <span class="st">&quot;вложила&quot;</span>, <span class="st">&quot;богиня&quot;</span>, <span class="st">&quot;державная&quot;</span>, <span class="st">&quot;гера&quot;</span>)</span>
<span id="cb189-3"><a href="функциональное-программирование.html#cb189-3" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">which</span>(x <span class="sc">%in%</span> y) <span class="co"># 2</span></span>
<span id="cb189-4"><a href="функциональное-программирование.html#cb189-4" tabindex="-1"></a>x[idx]</span></code></pre></div>
<pre><code>## [1] &quot;богиня&quot;</code></pre>
<p>Теперь заменяем фактические переменные на формальные.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="функциональное-программирование.html#cb191-1" tabindex="-1"></a>common_words <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb191-2"><a href="функциональное-программирование.html#cb191-2" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(x <span class="sc">%in%</span> y)</span>
<span id="cb191-3"><a href="функциональное-программирование.html#cb191-3" tabindex="-1"></a>  x[idx]</span>
<span id="cb191-4"><a href="функциональное-программирование.html#cb191-4" tabindex="-1"></a>}</span></code></pre></div>
<p>И применяем к новым данным.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="функциональное-программирование.html#cb192-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;лишь&quot;</span>, <span class="st">&quot;явилась&quot;</span>, <span class="st">&quot;заря&quot;</span>, <span class="st">&quot;розоперстая&quot;</span>, <span class="st">&quot;вестница&quot;</span>, <span class="st">&quot;утра&quot;</span>)</span>
<span id="cb192-2"><a href="функциональное-программирование.html#cb192-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;вестница&quot;</span>, <span class="st">&quot;утра&quot;</span>, <span class="st">&quot;заря&quot;</span>, <span class="st">&quot;на&quot;</span>, <span class="st">&quot;великий&quot;</span>, <span class="st">&quot;олимп&quot;</span>, <span class="st">&quot;восходила&quot;</span>)</span>
<span id="cb192-3"><a href="функциональное-программирование.html#cb192-3" tabindex="-1"></a><span class="fu">common_words</span>(x, y)</span></code></pre></div>
<pre><code>## [1] &quot;заря&quot;     &quot;вестница&quot; &quot;утра&quot;</code></pre>
<p>Ура, все работает! Запомните простое правило: если вы трижды скопировали код, пора писать функцию!</p>
</div>
<div id="область-видимости-переменных" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Область видимости переменных<a href="функциональное-программирование.html#область-видимости-переменных" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Напишем функцию, которая будет центрировать данные, то есть вычитать среднее из каждого значения (забудем на время, что это уже делает базовая <code>scale()</code>):</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="функциональное-программирование.html#cb194-1" tabindex="-1"></a>center <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ </span>
<span id="cb194-2"><a href="функциональное-программирование.html#cb194-2" tabindex="-1"></a>  n <span class="ot">=</span> x <span class="sc">-</span> <span class="fu">mean</span>(x)</span>
<span id="cb194-3"><a href="функциональное-программирование.html#cb194-3" tabindex="-1"></a>  <span class="fu">return</span>(n) </span>
<span id="cb194-4"><a href="функциональное-программирование.html#cb194-4" tabindex="-1"></a>}</span>
<span id="cb194-5"><a href="функциональное-программирование.html#cb194-5" tabindex="-1"></a></span>
<span id="cb194-6"><a href="функциональное-программирование.html#cb194-6" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>)</span>
<span id="cb194-7"><a href="функциональное-программирование.html#cb194-7" tabindex="-1"></a><span class="fu">center</span>(x) </span></code></pre></div>
<pre><code>## [1] -5  0  5</code></pre>
<p>Внутри нашей функции есть переменная <code>n</code>, которую не видно в глобальном окружении. Это <strong>локальная переменная</strong>. Область ее видимости – тело функции. Когда функция возвращает управление, переменная исчезает. Обратное неверно: глобальные переменные доступны в теле функции.</p>
</div>
<div id="аргументы-функции" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Аргументы функции<a href="функциональное-программирование.html#аргументы-функции" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Функция может принимать произвольное число аргументов. Доработаем наш код:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="функциональное-программирование.html#cb196-1" tabindex="-1"></a>center <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">na.rm =</span> F){</span>
<span id="cb196-2"><a href="функциональное-программирование.html#cb196-2" tabindex="-1"></a>  <span class="cf">if</span>(na.rm) { x <span class="ot">&lt;-</span> x[<span class="sc">!</span><span class="fu">is.na</span>(x)]} <span class="co"># добавим условие</span></span>
<span id="cb196-3"><a href="функциональное-программирование.html#cb196-3" tabindex="-1"></a>  x <span class="sc">-</span> <span class="fu">mean</span>(x) <span class="co"># на этот раз без return()</span></span>
<span id="cb196-4"><a href="функциональное-программирование.html#cb196-4" tabindex="-1"></a>}</span>
<span id="cb196-5"><a href="функциональное-программирование.html#cb196-5" tabindex="-1"></a></span>
<span id="cb196-6"><a href="функциональное-программирование.html#cb196-6" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="cn">NA</span>)</span>
<span id="cb196-7"><a href="функциональное-программирование.html#cb196-7" tabindex="-1"></a><span class="fu">center</span>(x)</span></code></pre></div>
<pre><code>## [1] NA NA NA</code></pre>
<p>Что произошло? Почему следующий код выдает другой результат?</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="функциональное-программирование.html#cb198-1" tabindex="-1"></a><span class="fu">center</span>(x, <span class="at">na.rm =</span> T)</span></code></pre></div>
<pre><code>## [1] -2.5  2.5</code></pre>
<p>Вычисления в R <strong>ленивы</strong>, то есть они откладываются до тех пор, пока не понадобится результат. Если вы зададите аргумент, который не нужен в теле функции, ошибки не будет.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="функциональное-программирование.html#cb200-1" tabindex="-1"></a>center <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">na.rm =</span> F, what_is_your_name){</span>
<span id="cb200-2"><a href="функциональное-программирование.html#cb200-2" tabindex="-1"></a>  <span class="cf">if</span>(na.rm) { x <span class="ot">&lt;-</span> x[<span class="sc">!</span><span class="fu">is.na</span>(x)]} <span class="co"># добавим условие</span></span>
<span id="cb200-3"><a href="функциональное-программирование.html#cb200-3" tabindex="-1"></a>  x <span class="sc">-</span> <span class="fu">mean</span>(x) <span class="co"># на этот раз без return()</span></span>
<span id="cb200-4"><a href="функциональное-программирование.html#cb200-4" tabindex="-1"></a>}</span>
<span id="cb200-5"><a href="функциональное-программирование.html#cb200-5" tabindex="-1"></a></span>
<span id="cb200-6"><a href="функциональное-программирование.html#cb200-6" tabindex="-1"></a><span class="fu">center</span>(x, <span class="at">na.rm =</span> T)</span></code></pre></div>
<pre><code>## [1] -2.5  2.5</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="функциональное-программирование.html#cb202-1" tabindex="-1"></a><span class="fu">center</span>(x, <span class="at">na.rm =</span> T, <span class="at">what_is_your_name =</span> <span class="st">&quot;Locusclassicus&quot;</span>)</span></code></pre></div>
<pre><code>## [1] -2.5  2.5</code></pre>
<p>Часто имеет смысл добавить условие остановки или сообщение, которое будет распечатано в консоль при выполнении.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="функциональное-программирование.html#cb204-1" tabindex="-1"></a>center <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb204-2"><a href="функциональное-программирование.html#cb204-2" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span>) {<span class="fu">stop</span>(<span class="st">&quot;И без меня посчитает&quot;</span>)}</span>
<span id="cb204-3"><a href="функциональное-программирование.html#cb204-3" tabindex="-1"></a>  x <span class="sc">-</span> <span class="fu">mean</span>(x) <span class="co"># на этот раз без return()</span></span>
<span id="cb204-4"><a href="функциональное-программирование.html#cb204-4" tabindex="-1"></a>}</span>
<span id="cb204-5"><a href="функциональное-программирование.html#cb204-5" tabindex="-1"></a></span>
<span id="cb204-6"><a href="функциональное-программирование.html#cb204-6" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb204-7"><a href="функциональное-программирование.html#cb204-7" tabindex="-1"></a><span class="fu">center</span>(x) <span class="co"># вернет ошибку</span></span></code></pre></div>
</div>
<div id="векторизируй-это" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Векторизируй это<a href="функциональное-программирование.html#векторизируй-это" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Теперь самое главное: если мы хотим применить функцию к каждому элементу вектора, то в большинстве случаев достаточно просто вызвать функцию. Это называется <strong>векторизация</strong>.</p>
<p>Это относится не только ко многим встроенным функциям R, но и к даже к операторам. <code>x + 4</code> в действительности представляет собой <code>+(x, 4)</code>:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="функциональное-программирование.html#cb205-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.51</span>, <span class="fl">3.8</span>)</span>
<span id="cb205-2"><a href="функциональное-программирование.html#cb205-2" tabindex="-1"></a></span>
<span id="cb205-3"><a href="функциональное-программирование.html#cb205-3" tabindex="-1"></a><span class="st">`</span><span class="at">+</span><span class="st">`</span>(x, <span class="dv">4</span>) </span></code></pre></div>
<pre><code>## [1] 5.20 6.51 7.80</code></pre>
<p>Ключевую роль здесь играет переработка данных, о которой мы уже говорили: короткий вектор повторяется до тех пор, пока его длина не сравняется с длиной более длинного вектора. Как-то так:</p>
<p><span class="math display">\[\left(
    \begin{array}{c}
      1.2 \\
      2.51 \\
      3.8
    \end{array}
  \right) + \left(
    \begin{array}{c}
      4 \\
      4 \\
      4
    \end{array}
  \right)\]</span></p>
<p>Понимание того, как действуют векторизованные вычисления, очень важно для написания корректного кода. Посмотрите на пример ниже: почему функция <code>is_article()</code> возвращает два значения, хотя на входе только одно?</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="функциональное-программирование.html#cb207-1" tabindex="-1"></a>is_article <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb207-2"><a href="функциональное-программирование.html#cb207-2" tabindex="-1"></a>  x <span class="sc">==</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;the&quot;</span>)</span>
<span id="cb207-3"><a href="функциональное-программирование.html#cb207-3" tabindex="-1"></a>}</span>
<span id="cb207-4"><a href="функциональное-программирование.html#cb207-4" tabindex="-1"></a></span>
<span id="cb207-5"><a href="функциональное-программирование.html#cb207-5" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">&quot;the&quot;</span></span>
<span id="cb207-6"><a href="функциональное-программирование.html#cb207-6" tabindex="-1"></a><span class="fu">is_article</span>(x)</span></code></pre></div>
<pre><code>## [1] FALSE  TRUE</code></pre>
<p>Поскольку векторы сравниваются поэлементно, то функция ниже вернет разный результат в зависимости от того, в каком порядке заданы элементы:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="функциональное-программирование.html#cb209-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;just&quot;</span>, <span class="st">&quot;the&quot;</span>)</span>
<span id="cb209-2"><a href="функциональное-программирование.html#cb209-2" tabindex="-1"></a><span class="fu">is_article</span>(x) </span></code></pre></div>
<pre><code>## [1] FALSE  TRUE</code></pre>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="функциональное-программирование.html#cb211-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;the&quot;</span>, <span class="st">&quot;just&quot;</span>)</span>
<span id="cb211-2"><a href="функциональное-программирование.html#cb211-2" tabindex="-1"></a><span class="fu">is_article</span>(x) <span class="co"># взрыв мозга</span></span></code></pre></div>
<pre><code>## [1] FALSE FALSE</code></pre>
<p>Подумайте, вектор какого типа и какой длины вернет код ниже.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="функциональное-программирование.html#cb213-1" tabindex="-1"></a>is_article <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { </span>
<span id="cb213-2"><a href="функциональное-программирование.html#cb213-2" tabindex="-1"></a>  articles <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;the&quot;</span>)</span>
<span id="cb213-3"><a href="функциональное-программирование.html#cb213-3" tabindex="-1"></a>  x <span class="sc">%in%</span> articles</span>
<span id="cb213-4"><a href="функциональное-программирование.html#cb213-4" tabindex="-1"></a>}</span>
<span id="cb213-5"><a href="функциональное-программирование.html#cb213-5" tabindex="-1"></a></span>
<span id="cb213-6"><a href="функциональное-программирование.html#cb213-6" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;the&quot;</span>, <span class="dv">5</span>), <span class="fu">rep</span>(<span class="st">&quot;if&quot;</span>, <span class="dv">5</span>))</span>
<span id="cb213-7"><a href="функциональное-программирование.html#cb213-7" tabindex="-1"></a><span class="fu">is_article</span>(x)</span></code></pre></div>
<pre><code>##  [1]  TRUE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
<div id="векторизованные-конструкции" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Векторизованные конструкции<a href="функциональное-программирование.html#векторизованные-конструкции" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="циклы" class="section level3 hasAnchor" number="5.5.1">
<h3><span class="header-section-number">5.5.1</span> Циклы<a href="функциональное-программирование.html#циклы" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Еще один способ повторить действия в R, при этом не копируя один и тот же код много раз, – это циклы.</p>
<blockquote>
<p>Один из главных принципов программирования на R гласит, что следует обходиться без циклов, а если это невозможно, то циклы должны быть простыми.</p>
<p>— Нормат Мэтлофф</p>
</blockquote>
<p>Существует два основных цикла: цикл <code>for</code> и цикл <code>while</code>. На практике чаще используется цикл <code>for</code>, потому что цикл <code>while</code> легко отправить в бесконечность.</p>
<div id="цикл-for" class="section level4 hasAnchor" number="5.5.1.1">
<h4><span class="header-section-number">5.5.1.1</span> Цикл <code>for</code><a href="функциональное-программирование.html#цикл-for" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Цикл ниже считает количество букв для каждого слова в векторе.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="функциональное-программирование.html#cb215-1" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;в&quot;</span>, <span class="st">&quot;мысли&quot;</span>, <span class="st">&quot;ему&quot;</span>, <span class="st">&quot;то&quot;</span>, <span class="st">&quot;вложила&quot;</span>, <span class="st">&quot;богиня&quot;</span>, <span class="st">&quot;державная&quot;</span>, <span class="st">&quot;гера&quot;</span>)</span>
<span id="cb215-2"><a href="функциональное-программирование.html#cb215-2" tabindex="-1"></a></span>
<span id="cb215-3"><a href="функциональное-программирование.html#cb215-3" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb215-4"><a href="функциональное-программирование.html#cb215-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> y) { </span>
<span id="cb215-5"><a href="функциональное-программирование.html#cb215-5" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nchar</span>(i)</span>
<span id="cb215-6"><a href="функциональное-программирование.html#cb215-6" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, n)</span>
<span id="cb215-7"><a href="функциональное-программирование.html#cb215-7" tabindex="-1"></a>}</span>
<span id="cb215-8"><a href="функциональное-программирование.html#cb215-8" tabindex="-1"></a></span>
<span id="cb215-9"><a href="функциональное-программирование.html#cb215-9" tabindex="-1"></a>result</span></code></pre></div>
<pre><code>## [1] 1 5 3 2 7 6 9 4</code></pre>
<p>В данном случае мы указали, что надо совершить какую-то операцию над каждым элементом вектора; но по сути это избыточно, потому что <code>nchar()</code> тоже векторизована.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="функциональное-программирование.html#cb217-1" tabindex="-1"></a><span class="fu">nchar</span>(y)</span></code></pre></div>
<pre><code>## [1] 1 5 3 2 7 6 9 4</code></pre>
<p>Поэтому чаще цикл <code>for</code> применяют к другим структурам данных. Например, к спискам и датафреймам. Загрузим и немного изменим датасет о гапаксах у Платона. Изменения нужны, так как цикл работает для данных только одного типа, в то время как в нашей таблице столбец <code>dialogue</code> содержит символьные строки, а <code>group</code> – фактор. Обратите внимание, что оператор <code>pipe</code> и функции из <code>dplyr</code> работают и с обычными датафреймами:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="функциональное-программирование.html#cb219-1" tabindex="-1"></a><span class="fu">rownames</span>(hapax_plato) <span class="ot">&lt;-</span> hapax_plato<span class="sc">$</span>dialogue </span>
<span id="cb219-2"><a href="функциональное-программирование.html#cb219-2" tabindex="-1"></a></span>
<span id="cb219-3"><a href="функциональное-программирование.html#cb219-3" tabindex="-1"></a>hapax_plato <span class="ot">&lt;-</span> hapax_plato <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>group, <span class="sc">-</span>dialogue) <span class="co"># </span></span>
<span id="cb219-4"><a href="функциональное-программирование.html#cb219-4" tabindex="-1"></a><span class="fu">str</span>(hapax_plato)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    26 obs. of  3 variables:
##  $ words: chr  &quot;8745&quot; &quot;8311&quot; &quot;17944&quot; &quot;4950&quot; ...
##  $ hapax: chr  &quot;36&quot; &quot;31&quot; &quot;122&quot; &quot;104&quot; ...
##  $ ratio: chr  &quot;0.004&quot; &quot;0.004&quot; &quot;0.007&quot; &quot;0.021&quot; ...</code></pre>
<p>Сейчас все данные в нашей таблице имеют тип <code>chr</code>, то есть строка, и при помощи цикла мы можем их трансформировать.</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="функциональное-программирование.html#cb221-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(hapax_plato)) {  <span class="co"># seq_along ≈ 1:length(x)</span></span>
<span id="cb221-2"><a href="функциональное-программирование.html#cb221-2" tabindex="-1"></a>  hapax_plato[,i] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hapax_plato[,i])</span>
<span id="cb221-3"><a href="функциональное-программирование.html#cb221-3" tabindex="-1"></a>}</span>
<span id="cb221-4"><a href="функциональное-программирование.html#cb221-4" tabindex="-1"></a></span>
<span id="cb221-5"><a href="функциональное-программирование.html#cb221-5" tabindex="-1"></a><span class="fu">str</span>(hapax_plato) <span class="co"># убеждаемся, что все получилось</span></span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    26 obs. of  3 variables:
##  $ words: num  8745 8311 17944 4950 4169 ...
##  $ hapax: num  36 31 122 104 19 87 15 125 12 32 ...
##  $ ratio: num  0.004 0.004 0.007 0.021 0.005 0.007 0.003 0.005 0.003 0.008 ...</code></pre>
<p>При помощи циклов можно не только трансформировать данные, но и создавать новые. Чтобы посчитать среднее для столбца, цикл писать не надо: для этого есть функция <code>colSums()</code> (или, для других задач, <code>rowSums()</code>). А вот посчитать медиану таким образом не получится, тут может пригодиться цикл.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="функциональное-программирование.html#cb223-1" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb223-2"><a href="функциональное-программирование.html#cb223-2" tabindex="-1"></a></span>
<span id="cb223-3"><a href="функциональное-программирование.html#cb223-3" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb223-4"><a href="функциональное-программирование.html#cb223-4" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb223-5"><a href="функциональное-программирование.html#cb223-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(hapax_plato)) { </span>
<span id="cb223-6"><a href="функциональное-программирование.html#cb223-6" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">median</span>(hapax_plato[,i])</span>
<span id="cb223-7"><a href="функциональное-программирование.html#cb223-7" tabindex="-1"></a>  medians <span class="ot">&lt;-</span> <span class="fu">c</span>(medians, m)</span>
<span id="cb223-8"><a href="функциональное-программирование.html#cb223-8" tabindex="-1"></a>}</span>
<span id="cb223-9"><a href="функциональное-программирование.html#cb223-9" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0.003 sec elapsed</code></pre>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="функциональное-программирование.html#cb225-1" tabindex="-1"></a>medians</span></code></pre></div>
<pre><code>## [1] 15589.500    94.500     0.007</code></pre>
<p>Мы сохранили результат, инициировав пустой вектор, к которому затем привязали данные по каждому столбцу. Это не всегда хорошая идея, поскольку для больших данных может сильно замедлить цикл<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a>. Еще один способ – сразу инициировать вектор нужной длины. Сравнить скорость можно при помощи пакета <code>tictoc</code>.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="функциональное-программирование.html#cb227-1" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb227-2"><a href="функциональное-программирование.html#cb227-2" tabindex="-1"></a>medians <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;double&quot;</span>, <span class="fu">ncol</span>(hapax_plato))</span>
<span id="cb227-3"><a href="функциональное-программирование.html#cb227-3" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(hapax_plato)) { </span>
<span id="cb227-4"><a href="функциональное-программирование.html#cb227-4" tabindex="-1"></a>  medians[i] <span class="ot">&lt;-</span> <span class="fu">median</span>(hapax_plato[,i])</span>
<span id="cb227-5"><a href="функциональное-программирование.html#cb227-5" tabindex="-1"></a>}</span>
<span id="cb227-6"><a href="функциональное-программирование.html#cb227-6" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0.003 sec elapsed</code></pre>
<p>Второй способ чуть быстрее, и для больших данных это может быть существенно (знала бы я это раньше).</p>
<div class="infobox">
<p>Вы уже заметили, что в циклах часто используется буква <code>i</code>. Но никакой особой магии в ней нет!</p>
</div>
</div>
<div id="цикл-while" class="section level4 hasAnchor" number="5.5.1.2">
<h4><span class="header-section-number">5.5.1.2</span> Цикл <code>while</code><a href="функциональное-программирование.html#цикл-while" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Как уже говорилось, с циклами <code>while</code> стоит быть осторожнее. Посмотрите, например, на этот цикл, который перебирает слова, пока не найдет слово длиной 6 букв. Что могло пойти не так?</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="функциональное-программирование.html#cb229-1" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb229-2"><a href="функциональное-программирование.html#cb229-2" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb229-3"><a href="функциональное-программирование.html#cb229-3" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb229-4"><a href="функциональное-программирование.html#cb229-4" tabindex="-1"></a><span class="cf">while</span> (n <span class="sc">!=</span> <span class="dv">6</span>) {</span>
<span id="cb229-5"><a href="функциональное-программирование.html#cb229-5" tabindex="-1"></a>  k <span class="ot">&lt;-</span> k <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb229-6"><a href="функциональное-программирование.html#cb229-6" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nchar</span>(y[k])</span>
<span id="cb229-7"><a href="функциональное-программирование.html#cb229-7" tabindex="-1"></a>}</span>
<span id="cb229-8"><a href="функциональное-программирование.html#cb229-8" tabindex="-1"></a>y[k]</span></code></pre></div>
<pre><code>## [1] &quot;богиня&quot;</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="функциональное-программирование.html#cb231-1" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0.003 sec elapsed</code></pre>
<p>То же самое можно сделать без цикла, причем быстрее!</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="функциональное-программирование.html#cb233-1" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb233-2"><a href="функциональное-программирование.html#cb233-2" tabindex="-1"></a>y[<span class="fu">nchar</span>(y) <span class="sc">==</span> <span class="dv">6</span>][<span class="dv">1</span>] </span></code></pre></div>
<pre><code>## [1] &quot;богиня&quot;</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="функциональное-программирование.html#cb235-1" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0 sec elapsed</code></pre>
<p>В целом, ничего незаконного в циклах нет, но</p>
<ul>
<li>множество вложенных друг в друга циклов сложно воспринимать;</li>
<li>порой они могут замедлить выполнение кода.</li>
</ul>
<p>И в базовом R, и в диалекте tidyverse для этого есть несколько решений, о которых скажем чуть ниже. Сначала рассмотрим еще одну векторизованную конструкцию – условие.</p>
</div>
</div>
<div id="условия" class="section level3 hasAnchor" number="5.5.2">
<h3><span class="header-section-number">5.5.2</span> Условия<a href="функциональное-программирование.html#условия" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Иногда необходимо ограничить выполнение функции неким условием. Короткие условия можно писать в одну строку без фигурных скобок.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="функциональное-программирование.html#cb237-1" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">nchar</span>(y) <span class="sc">&gt;</span> <span class="dv">6</span>)) <span class="fu">print</span>(<span class="st">&quot;многабукв&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;многабукв&quot;</code></pre>
<p>Более сложные и множественные условия требуют фигурных скобок. Можно сравнить это с условным периодом: протасис (всегда либо TRUE, либо FALSE) в круглых скобках, аподосис в фигурных.</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="функциональное-программирование.html#cb239-1" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">nchar</span>(y)) <span class="sc">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb239-2"><a href="функциональное-программирование.html#cb239-2" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;много букв&quot;</span>)</span>
<span id="cb239-3"><a href="функциональное-программирование.html#cb239-3" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">nchar</span>(y)) <span class="sc">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb239-4"><a href="функциональное-программирование.html#cb239-4" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;мало букв&quot;</span>)</span>
<span id="cb239-5"><a href="функциональное-программирование.html#cb239-5" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb239-6"><a href="функциональное-программирование.html#cb239-6" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;норм букв&quot;</span>)</span>
<span id="cb239-7"><a href="функциональное-программирование.html#cb239-7" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] &quot;много букв&quot;</code></pre>
<p>Также в R можно использовать специальную функцию:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="функциональное-программирование.html#cb241-1" tabindex="-1"></a><span class="fu">ifelse</span>((<span class="fu">sum</span>(<span class="fu">nchar</span>(y)) <span class="sc">&gt;</span> <span class="dv">10</span>), <span class="st">&quot;много букв&quot;</span>, <span class="st">&quot;мало букв&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;много букв&quot;</code></pre>
<p>Прописывая условие, не забывайте, что применение бинарного оператора к вектору возвращает логический вектор:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="функциональное-программирование.html#cb243-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb243-2"><a href="функциональное-программирование.html#cb243-2" tabindex="-1"></a>x <span class="sc">&gt;=</span> <span class="dv">5</span></span></code></pre></div>
<pre><code>##  [1] FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE</code></pre>
<p>Условия с таким логическим вектором используют первый его элемент (а вряд ли это то, что вам нужно):</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="функциональное-программирование.html#cb245-1" tabindex="-1"></a><span class="cf">if</span> (x <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="fu">print</span>(<span class="st">&quot;все сработало&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in if (x &gt;= 5) print(&quot;все сработало&quot;): the condition has length &gt; 1 and
## only the first element will be used</code></pre>
<p>Можно скорректировать код так:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="функциональное-программирование.html#cb247-1" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(x <span class="sc">&gt;=</span> <span class="dv">5</span>)) <span class="fu">print</span>(<span class="st">&quot;все сработало&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;все сработало&quot;</code></pre>
<p>По той же причине внутри условия не надо использовать логические операторы <code>|</code> (“или”) или <code>&amp;</code> (“и”), потому что они векторизованы:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="функциональное-программирование.html#cb249-1" tabindex="-1"></a>x <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">|</span> x <span class="sc">&gt;</span> <span class="dv">7</span></span></code></pre></div>
<pre><code>##  [1]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE</code></pre>
<p>Вместо этого можно применять <code>||</code> (“или”) или <code>&amp;&amp;</code> (“и”), которые остановятся, дойдя до первого истинного значения.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="функциональное-программирование.html#cb251-1" tabindex="-1"></a>x <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">||</span> x <span class="sc">&gt;</span> <span class="dv">7</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="вместо-циклов-базовый-r-и-tidyverse" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Вместо циклов: базовый R и tidyverse<a href="функциональное-программирование.html#вместо-циклов-базовый-r-и-tidyverse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Функция <strong><code>tapply()</code></strong> из базового R принимает на входе вектор, фактор (или список факторов) и функцию. Каждый фактор должен быть той же длины, что и вектор. Код ниже считает средний процент гапаксов по группам диалогов:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="функциональное-программирование.html#cb253-1" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;./datasets/HapaxPlato.Rdata&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="функциональное-программирование.html#cb254-1" tabindex="-1"></a><span class="co"># подготавливаем векторы </span></span>
<span id="cb254-2"><a href="функциональное-программирование.html#cb254-2" tabindex="-1"></a>my_fct <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(hapax_plato<span class="sc">$</span>group)</span>
<span id="cb254-3"><a href="функциональное-программирование.html#cb254-3" tabindex="-1"></a>my_vct <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hapax_plato<span class="sc">$</span>ratio)</span>
<span id="cb254-4"><a href="функциональное-программирование.html#cb254-4" tabindex="-1"></a></span>
<span id="cb254-5"><a href="функциональное-программирование.html#cb254-5" tabindex="-1"></a><span class="co"># применяем к ним функцию mean()</span></span>
<span id="cb254-6"><a href="функциональное-программирование.html#cb254-6" tabindex="-1"></a><span class="fu">tapply</span>(my_vct, my_fct, mean)</span></code></pre></div>
<pre><code>##          1          2          3 
## 0.00550000 0.00750000 0.01133333</code></pre>
<p>На диалекте tidyverse эта задача решается так:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="функциональное-программирование.html#cb256-1" tabindex="-1"></a>hapax_plato <span class="sc">%&gt;%</span> </span>
<span id="cb256-2"><a href="функциональное-программирование.html#cb256-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ratio =</span> <span class="fu">as.numeric</span>(ratio)) <span class="sc">%&gt;%</span> </span>
<span id="cb256-3"><a href="функциональное-программирование.html#cb256-3" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb256-4"><a href="функциональное-программирование.html#cb256-4" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(ratio))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   group   mean
##   &lt;dbl&gt;  &lt;dbl&gt;
## 1     1 0.0055
## 2     2 0.0075
## 3     3 0.0113</code></pre>
<p>Функция <strong><code>apply()</code></strong> вызывает функцию для каждой строки или столбца матрицы или датафрейма.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="функциональное-программирование.html#cb258-1" tabindex="-1"></a><span class="co"># избавляемся от факторов и строк</span></span>
<span id="cb258-2"><a href="функциональное-программирование.html#cb258-2" tabindex="-1"></a><span class="fu">rownames</span>(hapax_plato) <span class="ot">&lt;-</span> hapax_plato<span class="sc">$</span>dialogue</span>
<span id="cb258-3"><a href="функциональное-программирование.html#cb258-3" tabindex="-1"></a>hapax_plato <span class="ot">&lt;-</span> <span class="fu">subset</span>(hapax_plato, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(dialogue, group)) </span>
<span id="cb258-4"><a href="функциональное-программирование.html#cb258-4" tabindex="-1"></a></span>
<span id="cb258-5"><a href="функциональное-программирование.html#cb258-5" tabindex="-1"></a><span class="co"># преобразуем столбцы в числовой формат при помощи apply</span></span>
<span id="cb258-6"><a href="функциональное-программирование.html#cb258-6" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb258-7"><a href="функциональное-программирование.html#cb258-7" tabindex="-1"></a>hapax_plato<span class="ot">&lt;-</span> <span class="fu">apply</span>(hapax_plato, <span class="dv">2</span>, as.numeric)</span>
<span id="cb258-8"><a href="функциональное-программирование.html#cb258-8" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0.001 sec elapsed</code></pre>
<p>Сравните со скростью цикла, который мы написали выше:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="функциональное-программирование.html#cb260-1" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;./datasets/HapaxPlato.Rdata&quot;</span>)</span>
<span id="cb260-2"><a href="функциональное-программирование.html#cb260-2" tabindex="-1"></a><span class="co"># избавляемся от факторов и строк</span></span>
<span id="cb260-3"><a href="функциональное-программирование.html#cb260-3" tabindex="-1"></a><span class="fu">rownames</span>(hapax_plato) <span class="ot">&lt;-</span> hapax_plato<span class="sc">$</span>dialogue</span>
<span id="cb260-4"><a href="функциональное-программирование.html#cb260-4" tabindex="-1"></a>hapax_plato <span class="ot">&lt;-</span> <span class="fu">subset</span>(hapax_plato, <span class="at">select =</span> <span class="sc">-</span><span class="fu">c</span>(dialogue, group)) </span></code></pre></div>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="функциональное-программирование.html#cb261-1" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb261-2"><a href="функциональное-программирование.html#cb261-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(hapax_plato)) {  </span>
<span id="cb261-3"><a href="функциональное-программирование.html#cb261-3" tabindex="-1"></a>  hapax_plato[,i] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hapax_plato[,i])</span>
<span id="cb261-4"><a href="функциональное-программирование.html#cb261-4" tabindex="-1"></a>}</span>
<span id="cb261-5"><a href="функциональное-программирование.html#cb261-5" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<pre><code>## 0.002 sec elapsed</code></pre>
<p>Функция <code>apply()</code> позволяет применять к данным собственные функции, в том числе анонимные.</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="функциональное-программирование.html#cb263-1" tabindex="-1"></a>hapax_centered <span class="ot">&lt;-</span> <span class="fu">apply</span>(hapax_plato, <span class="dv">2</span>, <span class="cf">function</span>(x) x <span class="sc">-</span> <span class="fu">mean</span>(x))</span>
<span id="cb263-2"><a href="функциональное-программирование.html#cb263-2" tabindex="-1"></a><span class="fu">head</span>(hapax_centered)</span></code></pre></div>
<pre><code>##                 words      hapax         ratio
## Apology    -10619.423 -110.69231 -0.0031538462
## Charmides  -11053.423 -115.69231 -0.0031538462
## Cratylus    -1420.423  -24.69231 -0.0001538462
## Critias    -14414.423  -42.69231  0.0138461538
## Crito      -15195.423 -127.69231 -0.0021538462
## Euthydemus  -6911.423  -59.69231 -0.0001538462</code></pre>
<p>Опять-таки, все это решается (даже проще) в грамматике dplyr:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="функциональное-программирование.html#cb265-1" tabindex="-1"></a><span class="fu">as_tibble</span>(hapax_plato) <span class="sc">%&gt;%</span> </span>
<span id="cb265-2"><a href="функциональное-программирование.html#cb265-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">words =</span> words <span class="sc">-</span> <span class="fu">mean</span>(words), </span>
<span id="cb265-3"><a href="функциональное-программирование.html#cb265-3" tabindex="-1"></a>         <span class="at">hapax =</span> hapax <span class="sc">-</span> <span class="fu">mean</span>(hapax),</span>
<span id="cb265-4"><a href="функциональное-программирование.html#cb265-4" tabindex="-1"></a>         <span class="at">ratio =</span> ratio <span class="sc">-</span> <span class="fu">mean</span>(ratio))</span></code></pre></div>
<p>Видно, что по времени мы при этом сильно не выигрываем; к тому же, нам пришлось повторить один код три раза. Значит, надо что-то менять. Например, так<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="функциональное-программирование.html#cb266-1" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb266-2"><a href="функциональное-программирование.html#cb266-2" tabindex="-1"></a><span class="fu">as_tibble</span>(hapax_plato) <span class="sc">%&gt;%</span> </span>
<span id="cb266-3"><a href="функциональное-программирование.html#cb266-3" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="cf">function</span>(x) x <span class="sc">-</span> <span class="fu">mean</span>(x))</span>
<span id="cb266-4"><a href="функциональное-программирование.html#cb266-4" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div>
<p>Или даже так<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="функциональное-программирование.html#cb267-1" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">-</span> <span class="fu">mean</span>(x)</span>
<span id="cb267-2"><a href="функциональное-программирование.html#cb267-2" tabindex="-1"></a><span class="fu">as_tibble</span>(hapax_plato) <span class="sc">%&gt;%</span></span>
<span id="cb267-3"><a href="функциональное-программирование.html#cb267-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, fn)) <span class="sc">%&gt;%</span> <span class="fu">invisible</span>()</span></code></pre></div>
<p>В любом случае, нам удалось обойтись без цикла, код понятен и хорошо читается.</p>
<p>Функции <strong><code>lapply()</code></strong> и <strong><code>sapply()</code></strong> подходят для применения функций к спискам (и к датафреймам, которые по сути представляют собой прямоугольные списки).</p>
<p>Чтобы понять, как они работают, сначала создадим список.</p>
<div class="infobox">
<p>При анализе текста со списками приходится иметь дело достаточно часто: объекты типа <code>stylo.corpus</code>, которые создает пакет <a href="https://rdrr.io/cran/stylo"><code>stylo</code></a>, по сути являются списками.</p>
</div>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="функциональное-программирование.html#cb268-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;гнев&quot;</span>, <span class="st">&quot;богиня&quot;</span>, <span class="st">&quot;воспой&quot;</span>)</span>
<span id="cb268-2"><a href="функциональное-программирование.html#cb268-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;в&quot;</span>, <span class="st">&quot;мысли&quot;</span>, <span class="st">&quot;ему&quot;</span>, <span class="st">&quot;то&quot;</span>, <span class="st">&quot;вложила&quot;</span>, <span class="st">&quot;богиня&quot;</span>, <span class="st">&quot;державная&quot;</span>, <span class="st">&quot;гера&quot;</span>)</span>
<span id="cb268-3"><a href="функциональное-программирование.html#cb268-3" tabindex="-1"></a>corpus <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)</span></code></pre></div>
<p>Наш условный корпус – это список из 2 элементов (текстов), а каждый текст хранится как символьный вектор. Допустим, мы хотим взять из каждого диалога выборку размером 5 слов, то есть применить функцию <code>sample()</code> к элементам списка. При помощи <code>lapply()</code> (l = list) это делается так:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="функциональное-программирование.html#cb269-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0211</span>) </span>
<span id="cb269-2"><a href="функциональное-программирование.html#cb269-2" tabindex="-1"></a><span class="fu">lapply</span>(corpus, sample, <span class="dv">5</span>, <span class="at">replace =</span> T)</span></code></pre></div>
<pre><code>## $x
## [1] &quot;воспой&quot; &quot;воспой&quot; &quot;воспой&quot; &quot;богиня&quot; &quot;воспой&quot;
## 
## $y
## [1] &quot;державная&quot; &quot;вложила&quot;   &quot;то&quot;        &quot;мысли&quot;     &quot;вложила&quot;</code></pre>
<p>Функция <strong><code>sapply()</code></strong> ведет себя так же, но упрощает результат до вектора или матрицы (s = simplify).</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="функциональное-программирование.html#cb271-1" tabindex="-1"></a><span class="fu">sapply</span>(corpus, sample, <span class="dv">5</span>, <span class="at">replace =</span> T)</span></code></pre></div>
<pre><code>##      x        y          
## [1,] &quot;богиня&quot; &quot;ему&quot;      
## [2,] &quot;гнев&quot;   &quot;державная&quot;
## [3,] &quot;гнев&quot;   &quot;ему&quot;      
## [4,] &quot;богиня&quot; &quot;то&quot;       
## [5,] &quot;воспой&quot; &quot;мысли&quot;</code></pre>
<p>Функция <strong><code>vapply()</code></strong> позволяет задать тип данных на выходе.</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="функциональное-программирование.html#cb273-1" tabindex="-1"></a><span class="fu">vapply</span>(corpus, sample, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">replace =</span> T, <span class="fu">character</span>(<span class="dv">5</span>))</span></code></pre></div>
<pre><code>##      x        y        
## [1,] &quot;воспой&quot; &quot;то&quot;     
## [2,] &quot;богиня&quot; &quot;гера&quot;   
## [3,] &quot;гнев&quot;   &quot;вложила&quot;
## [4,] &quot;гнев&quot;   &quot;гера&quot;   
## [5,] &quot;гнев&quot;   &quot;мысли&quot;</code></pre>
<p>Поскольку наш “корпус” – это список, то применить грамматику <code>dplyr</code> не очень удобно, списко легко превращается в таблицу:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="функциональное-программирование.html#cb275-1" tabindex="-1"></a><span class="fu">stack</span>(corpus) <span class="co"># передвинуть и переименовать: `relocate()` и `rename()`</span></span></code></pre></div>
<pre><code>##       values ind
## 1       гнев   x
## 2     богиня   x
## 3     воспой   x
## 4          в   y
## 5      мысли   y
## 6        ему   y
## 7         то   y
## 8    вложила   y
## 9     богиня   y
## 10 державная   y
## 11      гера   y</code></pre>
<p>Теперь повторные выборки можно делать так:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="функциональное-программирование.html#cb277-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0211</span>)</span>
<span id="cb277-2"><a href="функциональное-программирование.html#cb277-2" tabindex="-1"></a><span class="fu">stack</span>(corpus) <span class="sc">%&gt;%</span> </span>
<span id="cb277-3"><a href="функциональное-программирование.html#cb277-3" tabindex="-1"></a>  <span class="fu">group_by</span>(ind) <span class="sc">%&gt;%</span> </span>
<span id="cb277-4"><a href="функциональное-программирование.html#cb277-4" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="dv">5</span>, <span class="at">replace =</span> T)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 2
## # Groups:   ind [2]
##    values    ind  
##    &lt;chr&gt;     &lt;fct&gt;
##  1 воспой    x    
##  2 воспой    x    
##  3 воспой    x    
##  4 богиня    x    
##  5 воспой    x    
##  6 державная y    
##  7 вложила   y    
##  8 то        y    
##  9 мысли     y    
## 10 вложила   y</code></pre>
</div>
<div id="purrr" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Purrr<a href="функциональное-программирование.html#purrr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>По-настоящему мощный инструмент для итераций – это пакет <code>purrr</code> из семейства <code>tidyverse</code><a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>. Разработчики предупреждают, что потребуется время, чтобы овладеть этим инструментом <span class="citation">(<a href="#ref-wickham2016">Wickham and Grolemund 2017</a>)</span>.</p>
<blockquote>
<p>You should never feel bad about using a loop instead of a map function. The map functions are a step up a tower of abstraction, and it can take a long time to get your head around how they work.</p>
<p>— Hadley Wickham &amp; Garrett Grolemund</p>
</blockquote>
<p>В семействе функций <code>map_</code> из этого пакета всего 23 вариации<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>. Вот основные из них:</p>
<ul>
<li><code>map()</code></li>
<li><code>map_lgl()</code></li>
<li><code>map_int()</code></li>
<li><code>map_dbl()</code></li>
<li><code>map_chr()</code></li>
</ul>
<p>Все они принимают на входе данные и функцию, которую следует к ним применить, и возвращают результат в том виде, который указан после подчеркивания. Просто <code>map()</code> вернет список, а <code>map_df()</code> – таблицу:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="функциональное-программирование.html#cb279-1" tabindex="-1"></a>hapax_plato  <span class="sc">%&gt;%</span></span>
<span id="cb279-2"><a href="функциональное-программирование.html#cb279-2" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb279-3"><a href="функциональное-программирование.html#cb279-3" tabindex="-1"></a>  <span class="fu">map_df</span>(center) <span class="sc">%&gt;%</span> </span>
<span id="cb279-4"><a href="функциональное-программирование.html#cb279-4" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##     words  hapax     ratio
##     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
## 1 -10619. -111.  -0.00315 
## 2 -11053. -116.  -0.00315 
## 3  -1420.  -24.7 -0.000154
## 4 -14414.  -42.7  0.0138  
## 5 -15195. -128.  -0.00215 
## 6  -6911.  -59.7 -0.000154</code></pre>
<p>Если на выходе требуется числовой вектор, то используем суффикс <code>dbl</code>:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="функциональное-программирование.html#cb281-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">map_dbl</span>(hapax_plato, mean), <span class="dv">3</span>) <span class="co"># это именованный вектор!</span></span></code></pre></div>
<pre><code>##     words     hapax     ratio 
## 19364.423   146.692     0.007</code></pre>
<p>Если необходимо несколько раз вызывать одну и ту же функцию с двумя аргументами, используется функция <code>map2()</code> <a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a>. Аргументы, которые меняются при каждом вызове, пишутся до функции; аргументы, которые остаются неизменны, – после.</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="функциональное-программирование.html#cb283-1" tabindex="-1"></a>mean <span class="ot">=</span> <span class="fu">list</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="sc">-</span><span class="dv">3</span>)</span>
<span id="cb283-2"><a href="функциональное-программирование.html#cb283-2" tabindex="-1"></a>sd <span class="ot">=</span> <span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">50</span>)</span>
<span id="cb283-3"><a href="функциональное-программирование.html#cb283-3" tabindex="-1"></a><span class="fu">map2</span>(mean, sd, rnorm, <span class="at">n =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1] 5.727572 4.812749 4.528140 6.565481 4.356073
## 
## [[2]]
## [1] 18.6183347  0.5775309 23.3592929  3.2133071 15.5702820
## 
## [[3]]
## [1] -10.13466  51.54818 -23.10523 -12.53555 -66.80735</code></pre>
<div class="float">
<img src="https://d33wubrfki0l68.cloudfront.net/68a21c4a103426c3b311c9dcfad8fe379d4892f1/55c9d/diagrams/lists-map2.png" style="width:60.0%" alt="Как работает map2()" />
<div class="figcaption">Как работает <code>map2()</code></div>
</div>
<p>Это можно обобщить следующим образом (<a href="https://adv-r.hadley.nz/functionals.html#map2">источник</a>):</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/7a545699ff7069a98329fcfbe6e42b734507eb16/211a5/diagrams/functionals/map2-arg.png" /></p>
<p>Можно было бы предположить, что должны быть и map3(), map4() и т.д., но во всех случаеях, когда у функции больше двух аргументов, используется <code>pmap()</code>.</p>
</div>
<div id="пример-итерации" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Пример итерации<a href="функциональное-программирование.html#пример-итерации" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Функция <code>map2()</code> в анализе текста: функция, которая принимает на входе список таблиц, созданных функцией <code>slide</code>, и назначает каждому окну id.<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>. Используется для создания скользящего окна при создании эмбеддингов.</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="функциональное-программирование.html#cb285-1" tabindex="-1"></a>corpus_tbl <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">stack</span>(corpus))</span>
<span id="cb285-2"><a href="функциональное-программирование.html#cb285-2" tabindex="-1"></a>windows <span class="ot">&lt;-</span> slider<span class="sc">::</span><span class="fu">slide</span>(corpus_tbl, <span class="sc">~</span>.x, <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb285-3"><a href="функциональное-программирование.html#cb285-3" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">map2</span>(<span class="at">.x =</span> windows, <span class="at">.y =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(windows), <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">window_id =</span> .y)) <span class="co"># out is a list</span></span>
<span id="cb285-4"><a href="функциональное-программирование.html#cb285-4" tabindex="-1"></a>out[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 2 × 3
##   values ind   window_id
##   &lt;chr&gt;  &lt;fct&gt;     &lt;int&gt;
## 1 богиня x             2
## 2 воспой x             2</code></pre>
<p>Поскольку второй аргумент – это, по сути, индекс, можно было бы использовать функцию <code>imap()</code>:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="функциональное-программирование.html#cb287-1" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">imap</span>(<span class="at">.x =</span> windows, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">window_id =</span> .y))</span>
<span id="cb287-2"><a href="функциональное-программирование.html#cb287-2" tabindex="-1"></a>out[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## [[1]]
## # A tibble: 2 × 3
##   values ind   window_id
##   &lt;chr&gt;  &lt;fct&gt;     &lt;int&gt;
## 1 богиня x             2
## 2 воспой x             2
## 
## [[2]]
## # A tibble: 2 × 3
##   values ind   window_id
##   &lt;chr&gt;  &lt;fct&gt;     &lt;int&gt;
## 1 воспой x             3
## 2 в      y             3</code></pre>
</div>
<div id="furrr" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> Furrr<a href="функциональное-программирование.html#furrr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Про параллельные вычисления, если останутся силы.</p>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-wickham2016" class="csl-entry">
Wickham, Hadley, and Garrett Grolemund. 2017. <em><span class="nocase">R for Data Science</span></em>. O’Reilly. <a href="https://r4ds.had.co.nz/index.html">https://r4ds.had.co.nz/index.html</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="14">
<li id="fn14"><p><a href="https://r4ds.had.co.nz/iteration.html" class="uri">https://r4ds.had.co.nz/iteration.html</a><a href="функциональное-программирование.html#fnref14" class="footnote-back">↩︎</a></p></li>
<li id="fn15"><p><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="uri">https://dplyr.tidyverse.org/reference/mutate_all.html</a><a href="функциональное-программирование.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p><a href="https://dplyr.tidyverse.org/articles/colwise.html" class="uri">https://dplyr.tidyverse.org/articles/colwise.html</a><a href="функциональное-программирование.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p><a href="https://purrr.tidyverse.org/" class="uri">https://purrr.tidyverse.org/</a><a href="функциональное-программирование.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p><a href="https://adv-r.hadley.nz/functionals.html" class="uri">https://adv-r.hadley.nz/functionals.html</a><a href="функциональное-программирование.html#fnref18" class="footnote-back">↩︎</a></p></li>
<li id="fn19"><p><a href="https://adv-r.hadley.nz/functionals.html" class="uri">https://adv-r.hadley.nz/functionals.html</a><a href="функциональное-программирование.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p>Пример отсюда, с некоторыми упрощениями: <a href="https://smltar.com/embeddings.html#understand-word-embeddings-by-finding-them-yourself" class="uri">https://smltar.com/embeddings.html#understand-word-embeddings-by-finding-them-yourself</a>. Подробный разбор в <a href="https://vk.com/video-211800158_456239215">видео</a><a href="функциональное-программирование.html#fnref20" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="опрятные-данные.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="blocks.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/04-iterate.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
